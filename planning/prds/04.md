# Product Requirements Document (PRD)

## Admin Area for Waterman Report

**Version:** 1.0  
**Date:** 2025-12-28  
**Status:** Draft

---

## Overview

Create an administrative interface for managing the Waterman application. The admin area will enable administrators to manage spots (CRUD operations and configuration), manage system prompts for sports and spots, view key performance indicators (KPIs) and logs, and trigger scraping/scoring operations manually.

---

## Goals

1. **Spot Management**: Complete CRUD operations for spots with ability to configure all spot properties
2. **Prompt Management**: Manage system prompts for sports and spot-sport combinations
3. **System Monitoring**: View KPIs, logs, and system health metrics
4. **Manual Operations**: Trigger scraping and scoring operations on-demand
5. **Secure Access**: Admin-only access with authentication

---

## Current State Analysis

### Existing System

**Current Behavior**:

- Spots are managed via Convex mutations (`spots.addSpot`, `spots.updateWindySpotId`)
- Prompts are stored in database (`scoring_prompts`, `system_sport_prompts` tables)
- Scraping is triggered via API endpoint (`/api/scrape`) or scripts
- Scoring happens automatically after scraping (async)
- No centralized admin interface
- No authentication system (application is anonymous)

**Limitations**:

- Spot management requires direct database access or script execution
- Prompt management requires database access
- No visibility into system health, KPIs, or logs
- No way to trigger operations from UI
- No admin authentication

---

## Requirements

### 1. Authentication & Authorization

#### 1.1 Admin Authentication

**Feature**: Secure admin access to the admin area

**Requirements**:

- Admin-only route: `/admin/*`
- Authentication required to access admin routes
- Simple password-based authentication (for V1)
- Session management (persist login across page refreshes)
- Sign out functionality

**Implementation**:

- Admin password stored in environment variable (`ADMIN_PASSWORD`)
- Session stored in secure HTTP-only cookie
- Protected route middleware checks authentication
- Redirect to `/admin/login` if not authenticated

**Future Enhancement** (V2):

- Multi-admin support with user accounts
- Role-based access control
- Two-factor authentication

#### 1.2 Authorization

**Feature**: Ensure only authenticated admins can access admin functions

**Requirements**:

- All admin API routes require authentication
- All admin Convex mutations/queries require authentication check
- Frontend routes protected by middleware

**Implementation**:

- Check authentication in Convex functions (admin-only mutations/queries)
- Verify session token matches admin credentials
- Return 401/403 errors for unauthorized access

---

### 2. Spot Management

#### 2.1 List Spots

**Feature**: View all spots in a table/list view

**Requirements**:

- Display all spots with key information:
  - Name
  - Country
  - Sports supported
  - Windy.app URL
  - Windy Spot ID
  - Webcam URL (if available)
  - Live Report URL (if available)
- Sortable columns (name, country, sports)
- Search/filter functionality
- Pagination (if many spots)

**UI Components**:

- Table view with sortable columns
- Search bar
- "Add New Spot" button
- Edit/Delete actions per row

#### 2.2 Create Spot

**Feature**: Add a new spot to the system

**Requirements**:

- Form with all spot fields:
  - **Name** (required): Spot name
  - **URL** (required): Windy.app URL
  - **Country** (optional): Country location
  - **Windy Spot ID** (optional): Windy.app spot ID for API access
  - **Sports** (optional): Array of sports (multi-select: wingfoil, surfing)
  - **Webcam URL** (optional): Webcam stream URL
  - **Webcam Stream Source** (optional): "iol" or "quanteec"
  - **Live Report URL** (optional): Live wind report URL
- Validation:
  - Name and URL required
  - URL must be valid Windy.app URL
  - Sports must be valid sport names
- Success message after creation
- Redirect to spot detail/edit page

**Convex Mutation**: `admin.addSpot` (or extend existing `spots.addSpot` with admin check)

#### 2.3 Edit Spot

**Feature**: Update an existing spot's properties

**Requirements**:

- Pre-populated form with current spot data
- Same fields as Create Spot
- Update all fields (including optional ones)
- Validation same as Create
- Success message after update
- Option to delete spot from edit page

**Convex Mutation**: `admin.updateSpot`

**Fields to Support**:

- All fields from `spots` table schema:
  - `name`, `url`, `country`, `windySpotId`, `sports`, `webcamUrl`, `webcamStreamSource`, `liveReportUrl`

#### 2.4 Delete Spot

**Feature**: Remove a spot from the system

**Requirements**:

- Confirmation dialog before deletion
- Warn about cascading effects:
  - Associated `spotConfigs` will be deleted
  - Associated `forecast_slots` will be deleted
  - Associated `scoring_prompts` will be deleted
  - Associated `condition_scores` will be deleted
- Soft delete option (future): Mark as deleted instead of hard delete
- Success message after deletion

**Convex Mutation**: `admin.deleteSpot`

**Cascading Deletes**:

- Delete all `spotConfigs` for this spot
- Delete all `forecast_slots` for this spot
- Delete all `tides` for this spot
- Delete all `scrapes` for this spot
- Delete all `scoring_prompts` for this spot
- Delete all `condition_scores` for this spot

#### 2.5 Spot Configuration Management

**Feature**: Manage sport-specific configurations for spots

**Requirements**:

- View all configs for a spot (one per sport)
- Create/edit/delete spot configs
- Form fields based on sport type:

**Wingfoiling Config**:

- `minSpeed` (optional): Minimum wind speed in knots
- `minGust` (optional): Minimum gust speed in knots
- `directionFrom` (optional): Wind direction range start (0-360°)
- `directionTo` (optional): Wind direction range end (0-360°)

**Surfing Config**:

- `minSwellHeight` (optional): Minimum swell height in meters
- `maxSwellHeight` (optional): Maximum swell height in meters
- `swellDirectionFrom` (optional): Swell direction range start
- `swellDirectionTo` (optional): Swell direction range end
- `minPeriod` (optional): Minimum wave period in seconds
- `optimalTide` (optional): "high", "low", or "both"

**UI**:

- Tab or section per sport on spot edit page
- Form for each sport config
- Save/delete config buttons

**Convex Mutations**:

- `admin.addSpotConfig`
- `admin.updateSpotConfig`
- `admin.deleteSpotConfig`

---

### 3. Prompt Management

#### 3.1 System Sport Prompts

**Feature**: Manage system-level prompts for each sport

**Requirements**:

- View all system sport prompts
- Edit system sport prompts
- Create new system sport prompts (for new sports)
- Enable/disable prompts

**Fields**:

- **Sport** (required): Sport name (e.g., "wingfoil", "surfing")
- **Prompt** (required): Sport evaluation guidelines text
- **Is Active** (boolean): Enable/disable this prompt

**UI**:

- List view of all system prompts
- Edit form with text area for prompt
- Toggle for active/inactive
- Save button

**Convex Functions**:

- Query: `admin.listSystemSportPrompts`
- Mutation: `admin.updateSystemSportPrompt`
- Mutation: `admin.createSystemSportPrompt`
- Mutation: `admin.toggleSystemSportPrompt`

#### 3.2 Spot-Sport Prompts

**Feature**: Manage spot-specific prompts for each spot-sport combination

**Requirements**:

- View all spot-sport prompts
- Filter by spot or sport
- Create/edit/delete spot-sport prompts
- Enable/disable prompts

**Fields**:

- **Spot** (required): Spot selection dropdown
- **Sport** (required): Sport selection dropdown
- **Spot Prompt** (required): Spot-specific characteristics text
- **Temporal Prompt** (required): Temporal context instructions text
- **Is Active** (boolean): Enable/disable this prompt

**UI**:

- Table/list view with spot, sport, active status
- Search/filter by spot or sport
- Edit form with:
  - Spot selector (dropdown)
  - Sport selector (dropdown)
  - Text area for spot prompt
  - Text area for temporal prompt
  - Toggle for active/inactive
- Create new prompt button
- Delete button (with confirmation)

**Convex Functions**:

- Query: `admin.listSpotSportPrompts` (with optional filters)
- Query: `admin.getSpotSportPrompt`
- Mutation: `admin.createSpotSportPrompt`
- Mutation: `admin.updateSpotSportPrompt`
- Mutation: `admin.deleteSpotSportPrompt`
- Mutation: `admin.toggleSpotSportPrompt`

**Note**: System sport prompts are stored separately in `system_sport_prompts` table. Spot-sport prompts are stored in `scoring_prompts` table with `userId: null`.

---

### 4. System Monitoring (KPIs & Logs)

#### 4.1 Key Performance Indicators (KPIs)

**Feature**: Display system health and performance metrics

**KPIs to Display**:

1. **Data Freshness**:
   - Most recent scrape timestamp (per spot)
   - Time since last scrape
   - Number of spots with stale data (> 24 hours old)

2. **Scraping Metrics**:
   - Total scrapes today
   - Successful scrapes today
   - Failed scrapes today
   - Success rate percentage
   - Average scrape duration

3. **Scoring Metrics**:
   - Total scores generated today
   - Scoring success rate
   - Average scoring latency
   - Failed scores count

4. **Data Volume**:
   - Total spots
   - Total forecast slots (last 7 days)
   - Total condition scores (last 7 days)
   - Database size (if available)

5. **System Health**:
   - API health status (Groq API)
   - Convex function execution times
   - Error rate (last 24 hours)

**UI**:

- Dashboard page with KPI cards/widgets
- Charts/graphs for trends (optional, V2)
- Color coding (green/yellow/red) for health status
- Refresh button to update metrics

**Convex Queries**:

- `admin.getKPIs`: Aggregate all KPI data
- `admin.getScrapeStats`: Scraping metrics
- `admin.getScoringStats`: Scoring metrics
- `admin.getDataVolume`: Data volume metrics

#### 4.2 Logs View

**Feature**: View system logs for debugging and monitoring

**Log Types**:

1. **Scraping Logs**:
   - Scrape execution records
   - Success/failure status
   - Error messages
   - Timestamp
   - Spot ID
   - Slots count

2. **Scoring Logs**:
   - Score generation records
   - Success/failure status
   - Error messages
   - Timestamp
   - Spot ID, Sport, Slot ID
   - Model used

3. **System Logs**:
   - Convex function errors
   - API errors
   - General system errors

**UI**:

- Log viewer with:
  - Filter by log type (scraping, scoring, system)
  - Filter by date range
  - Filter by spot (for scraping/scoring logs)
  - Search functionality
  - Pagination
  - Export logs (optional, V2)

**Log Display**:

- Table view with columns:
  - Timestamp
  - Type (scraping/scoring/system)
  - Status (success/error)
  - Message/Details
  - Spot ID (if applicable)
  - Expandable row for full error details

**Convex Queries**:

- `admin.getScrapes`: List scrape records with filters
- `admin.getScoringLogs`: List scoring execution records
- `admin.getSystemLogs`: List system errors (from Convex logs or custom logging)

**Data Sources**:

- `scrapes` table (scraping logs)
- `condition_scores` table with `scoredAt` (scoring logs)
- Convex logs API (system logs)

---

### 5. Manual Operations

#### 5.1 Trigger Scrape

**Feature**: Manually trigger a scrape for one or more spots

**Requirements**:

- Select spot(s) to scrape (multi-select dropdown or checkboxes)
- "Scrape All" option
- Trigger scrape button
- Show scrape progress/status:
  - Loading indicator while scraping
  - Success/failure message
  - Number of slots collected
  - Error message if failed
- Real-time updates (optional, V2)

**UI**:

- Spot selector (multi-select)
- "Trigger Scrape" button
- Status display (loading, success, error)
- Results summary

**Implementation**:

- Call existing `/api/scrape` endpoint or Convex action
- Pass spot IDs as parameters
- Display results in UI

**Convex Action**: `admin.triggerScrape`

- Accepts array of spot IDs
- Calls scraping logic (similar to `scripts/scrape.mjs`)
- Returns scrape results

#### 5.2 Trigger Scoring

**Feature**: Manually trigger scoring for unscored slots

**Requirements**:

- Select spot(s) to score (optional, if not selected, score all)
- Select sport(s) to score (optional, if not selected, score all sports)
- Select date range (optional, default: last 7 days)
- "Score All Unscored" option
- Trigger scoring button
- Show scoring progress:
  - Loading indicator
  - Progress counter (X of Y slots scored)
  - Success/failure message
  - Number of scores generated
  - Error summary if any failures

**UI**:

- Spot selector (optional, multi-select)
- Sport selector (optional, multi-select)
- Date range picker (optional)
- "Trigger Scoring" button
- Progress bar/counter
- Results summary

**Convex Action**: `admin.triggerScoring`

- Accepts optional filters: `spotIds`, `sports`, `dateRange`
- Finds unscored slots matching filters
- Calls scoring logic (similar to `scoreForecastSlots`)
- Returns scoring results (success count, failure count, errors)

**Use Cases**:

- Backfill scores for historical data
- Re-score slots after prompt changes
- Score specific spots/sports for testing

---

## Database Schema Changes

### No New Tables Required

All necessary tables already exist:

- `spots`: Spot data
- `spotConfigs`: Spot configurations
- `scoring_prompts`: Spot-sport prompts
- `system_sport_prompts`: System sport prompts
- `scrapes`: Scrape logs
- `condition_scores`: Scoring logs (via `scoredAt` field)

### Optional: Admin Sessions Table

**New Table**: `admin_sessions` (optional, if using database sessions)

```typescript
admin_sessions: defineTable({
  sessionToken: v.string(), // Session identifier
  expiresAt: v.number(), // Session expiration timestamp
  createdAt: v.number(), // Session creation timestamp
  lastActivityAt: v.number(), // Last activity timestamp
  ipAddress: v.optional(v.string()), // IP address (for security)
})
  .index("by_session_token", ["sessionToken"])
  .index("by_expires_at", ["expiresAt"]); // For cleanup
```

**Alternative**: Use HTTP-only cookies with JWT tokens (no database table needed)

---

## Implementation Details

### 1. Authentication System

#### 1.1 Admin Login

**Route**: `/admin/login`

**Components**:

- `app/admin/login/page.js`
- `components/admin/LoginForm.js`

**Flow**:

1. User enters admin password
2. Submit form
3. Verify password against `ADMIN_PASSWORD` env variable
4. Create session (cookie or database)
5. Redirect to `/admin`

**Convex Action**: `admin.authenticate`

```typescript
export const authenticate = action({
  args: { password: v.string() },
  handler: async (ctx, args) => {
    const adminPassword = process.env.ADMIN_PASSWORD;
    if (args.password !== adminPassword) {
      throw new Error("Invalid password");
    }
    // Create session token
    // Return session token
  },
});
```

#### 1.2 Session Management

**Option A: HTTP-Only Cookies** (Recommended for V1)

- Store session token in HTTP-only cookie
- Verify token on each admin request
- Simple, secure, no database needed

**Option B: Database Sessions**

- Store sessions in `admin_sessions` table
- More control, allows session management UI

**Decision**: Use Option A (HTTP-only cookies) for V1 simplicity

#### 1.3 Protected Routes

**Middleware**: `middleware.js` or route protection in Next.js

```typescript
// Check authentication on /admin/* routes
export function middleware(request) {
  if (request.nextUrl.pathname.startsWith("/admin")) {
    // Check for admin session cookie
    // Redirect to /admin/login if not authenticated
  }
}
```

### 2. Admin API Functions

#### 2.1 Spot Management Functions

**Query**: `admin.listSpots`

```typescript
export const listSpots = query({
  args: {},
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Return all spots
  },
});
```

**Mutation**: `admin.createSpot`

```typescript
export const createSpot = mutation({
  args: {
    name: v.string(),
    url: v.string(),
    country: v.optional(v.string()),
    windySpotId: v.optional(v.string()),
    sports: v.optional(v.array(v.string())),
    webcamUrl: v.optional(v.string()),
    webcamStreamSource: v.optional(v.string()),
    liveReportUrl: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Validate input
    // Create spot
    // Return spot ID
  },
});
```

**Mutation**: `admin.updateSpot`

```typescript
export const updateSpot = mutation({
  args: {
    spotId: v.id("spots"),
    // ... all spot fields (optional)
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Update spot
    // Return success
  },
});
```

**Mutation**: `admin.deleteSpot`

```typescript
export const deleteSpot = mutation({
  args: { spotId: v.id("spots") },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Delete cascading records:
    //   - spotConfigs
    //   - forecast_slots
    //   - tides
    //   - scrapes
    //   - scoring_prompts
    //   - condition_scores
    // Delete spot
    // Return success
  },
});
```

#### 2.2 Prompt Management Functions

**Query**: `admin.listSystemSportPrompts`

```typescript
export const listSystemSportPrompts = query({
  args: {},
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Return all system sport prompts
  },
});
```

**Mutation**: `admin.updateSystemSportPrompt`

```typescript
export const updateSystemSportPrompt = mutation({
  args: {
    sport: v.string(),
    prompt: v.string(),
    isActive: v.optional(v.boolean()),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Update or create system sport prompt
    // Return success
  },
});
```

**Query**: `admin.listSpotSportPrompts`

```typescript
export const listSpotSportPrompts = query({
  args: {
    spotId: v.optional(v.id("spots")),
    sport: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Filter by spotId and/or sport if provided
    // Return matching prompts
  },
});
```

**Mutation**: `admin.createSpotSportPrompt`

```typescript
export const createSpotSportPrompt = mutation({
  args: {
    spotId: v.id("spots"),
    sport: v.string(),
    spotPrompt: v.string(),
    temporalPrompt: v.string(),
    isActive: v.optional(v.boolean()),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Create prompt (userId: null for system prompts)
    // Return prompt ID
  },
});
```

#### 2.3 KPI Functions

**Query**: `admin.getKPIs`

```typescript
export const getKPIs = query({
  args: {},
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Aggregate KPI data:
    //   - Most recent scrape per spot
    //   - Scrape stats (today)
    //   - Scoring stats (today)
    //   - Data volume
    // Return KPI object
  },
});
```

**Query**: `admin.getScrapeStats`

```typescript
export const getScrapeStats = query({
  args: {
    dateRange: v.optional(
      v.object({
        start: v.number(),
        end: v.number(),
      })
    ),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Query scrapes table
    // Calculate: total, successful, failed, success rate
    // Return stats
  },
});
```

#### 2.4 Log Functions

**Query**: `admin.getScrapes`

```typescript
export const getScrapes = query({
  args: {
    spotId: v.optional(v.id("spots")),
    startDate: v.optional(v.number()),
    endDate: v.optional(v.number()),
    limit: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Query scrapes table with filters
    // Return scrape records
  },
});
```

#### 2.5 Operation Functions

**Action**: `admin.triggerScrape`

```typescript
export const triggerScrape = action({
  args: {
    spotIds: v.optional(v.array(v.id("spots"))),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // If spotIds provided, scrape those spots
    // Otherwise, scrape all spots
    // Call scraping logic (similar to scripts/scrape.mjs)
    // Return results
  },
});
```

**Action**: `admin.triggerScoring`

```typescript
export const triggerScoring = action({
  args: {
    spotIds: v.optional(v.array(v.id("spots"))),
    sports: v.optional(v.array(v.string())),
    dateRange: v.optional(
      v.object({
        start: v.number(),
        end: v.number(),
      })
    ),
  },
  handler: async (ctx, args) => {
    // Verify admin authentication
    // Find unscored slots matching filters
    // Call scoring logic
    // Return results (success count, failure count, errors)
  },
});
```

### 3. Authentication Helper

**Convex Function**: `admin.verifyAdmin`

```typescript
export const verifyAdmin = query({
  args: {
    sessionToken: v.string(),
  },
  handler: async (ctx, args) => {
    // Verify session token
    // Return { isAuthenticated: boolean }
  },
});
```

**Usage**: Call this query on each admin page load to verify authentication.

---

## Frontend Implementation

### 1. Admin Layout

**Route Structure**:

```
/admin
  /login          # Login page
  /               # Dashboard (KPIs)
  /spots          # Spot management
    /new          # Create spot
    /[id]         # Edit spot
  /prompts        # Prompt management
    /system       # System sport prompts
    /spots        # Spot-sport prompts
  /logs           # Logs viewer
  /operations     # Manual operations
```

**Layout Component**: `app/admin/layout.js`

- Admin navigation sidebar
- Header with "Sign Out" button
- Protected route wrapper

### 2. Admin Pages

#### 2.1 Dashboard (`/admin`)

**Components**:

- `components/admin/Dashboard.js`
- `components/admin/KPICard.js`
- `components/admin/KPIChart.js` (optional, V2)

**Features**:

- KPI cards in grid layout
- Refresh button
- Auto-refresh every 30 seconds (optional)

#### 2.2 Spot Management (`/admin/spots`)

**Components**:

- `components/admin/SpotsList.js`
- `components/admin/SpotForm.js`
- `components/admin/SpotConfigForm.js`

**Features**:

- Table view of all spots
- Search/filter
- "Add New Spot" button
- Edit/Delete actions
- Spot config management (tabs per sport)

#### 2.3 Prompt Management (`/admin/prompts`)

**Components**:

- `components/admin/PromptsList.js`
- `components/admin/PromptForm.js`
- `components/admin/SystemPromptEditor.js`
- `components/admin/SpotPromptEditor.js`

**Features**:

- Tabs: "System Prompts" and "Spot Prompts"
- List view with edit/delete
- Form for creating/editing prompts
- Text area with syntax highlighting (optional)

#### 2.4 Logs Viewer (`/admin/logs`)

**Components**:

- `components/admin/LogsViewer.js`
- `components/admin/LogsTable.js`
- `components/admin/LogsFilters.js`

**Features**:

- Filter by type, date, spot
- Search functionality
- Pagination
- Expandable rows for details

#### 2.5 Operations (`/admin/operations`)

**Components**:

- `components/admin/ScrapeTrigger.js`
- `components/admin/ScoringTrigger.js`
- `components/admin/OperationStatus.js`

**Features**:

- Spot selector for scraping
- Filters for scoring
- Progress indicators
- Results display

### 3. Shared Components

**Components**:

- `components/admin/AdminLayout.js`: Layout wrapper
- `components/admin/AdminNav.js`: Navigation sidebar
- `components/admin/ProtectedRoute.js`: Route protection wrapper
- `components/admin/ConfirmDialog.js`: Confirmation dialogs

---

## Security Considerations

### 1. Authentication Security

- **Password Storage**: Store `ADMIN_PASSWORD` in environment variable (never in code)
- **Session Security**: Use HTTP-only, Secure, SameSite cookies
- **Password Strength**: Enforce strong password (future)
- **Rate Limiting**: Limit login attempts (prevent brute force)

### 2. Authorization

- **Route Protection**: All `/admin/*` routes require authentication
- **API Protection**: All admin Convex functions verify authentication
- **CSRF Protection**: Use SameSite cookies and CSRF tokens

### 3. Input Validation

- **Client-Side**: Validate all form inputs
- **Server-Side**: Validate all Convex function arguments
- **Sanitization**: Sanitize user inputs (especially for prompts)

### 4. Data Access

- **Read-Only Queries**: Some queries may be read-only (logs, KPIs)
- **Write Operations**: All mutations require authentication
- **Audit Logging**: Log all admin actions (future)

---

## Migration Strategy

### Phase 1: Authentication & Basic Structure

1. **Authentication System**:
   - Create admin login page
   - Implement session management
   - Add route protection middleware
   - Create authentication Convex functions

2. **Admin Layout**:
   - Create admin layout component
   - Add navigation sidebar
   - Add protected route wrapper

3. **Dashboard**:
   - Create dashboard page
   - Implement KPI queries
   - Display KPI cards

### Phase 2: Spot Management

1. **Spot CRUD**:
   - Create spots list page
   - Create spot form component
   - Implement create/update/delete mutations
   - Add spot config management

2. **Testing**:
   - Test all CRUD operations
   - Test validation
   - Test cascading deletes

### Phase 3: Prompt Management

1. **System Prompts**:
   - Create system prompts page
   - Implement CRUD for system prompts

2. **Spot Prompts**:
   - Create spot prompts page
   - Implement CRUD for spot prompts

### Phase 4: Monitoring & Operations

1. **KPIs**:
   - Enhance dashboard with all KPIs
   - Add charts (optional)

2. **Logs**:
   - Create logs viewer
   - Implement log queries
   - Add filters and search

3. **Operations**:
   - Create operations page
   - Implement scrape trigger
   - Implement scoring trigger

---

## Testing Requirements

### Authentication

- Test login with correct password
- Test login with incorrect password
- Test session persistence
- Test session expiration
- Test sign out
- Test protected route access

### Spot Management

- Test create spot (all fields)
- Test update spot
- Test delete spot (verify cascading deletes)
- Test validation (required fields, URL format)
- Test spot config CRUD

### Prompt Management

- Test system prompt CRUD
- Test spot prompt CRUD
- Test prompt validation
- Test enable/disable prompts

### Monitoring

- Test KPI queries return correct data
- Test log queries with filters
- Test log pagination

### Operations

- Test trigger scrape (single spot, multiple spots, all spots)
- Test trigger scoring (with various filters)
- Test progress display
- Test error handling

---

## Success Criteria

### V1 Success Metrics

- ✅ Admin can log in securely
- ✅ Admin can view all spots
- ✅ Admin can create/edit/delete spots
- ✅ Admin can manage spot configurations
- ✅ Admin can view/edit system prompts
- ✅ Admin can view/edit spot-sport prompts
- ✅ Admin can view KPIs and logs
- ✅ Admin can trigger scraping
- ✅ Admin can trigger scoring
- ✅ All operations require authentication
- ✅ No unauthorized access to admin functions

### User Experience

- ✅ Admin interface is intuitive and easy to navigate
- ✅ Forms are clear and well-validated
- ✅ Operations provide clear feedback (loading, success, error)
- ✅ Logs are searchable and filterable

---

## Risks & Mitigations

### Risk 1: Security Vulnerabilities

- **Impact**: High - Unauthorized access to admin functions
- **Mitigation**:
  - Use secure authentication (HTTP-only cookies)
  - Verify authentication in all Convex functions
  - Use environment variables for secrets
  - Implement rate limiting on login

### Risk 2: Data Loss from Deletes

- **Impact**: High - Accidental deletion of spots/data
- **Mitigation**:
  - Confirmation dialogs for all delete operations
  - Clear warnings about cascading effects
  - Consider soft deletes (mark as deleted, don't hard delete)
  - Regular database backups

### Risk 3: Performance Issues

- **Impact**: Medium - Slow admin interface
- **Mitigation**:
  - Paginate large lists (spots, logs)
  - Index database queries properly
  - Cache KPI data (refresh every 30s, not on every request)
  - Optimize log queries with date ranges

### Risk 4: Complex Operations Blocking UI

- **Impact**: Medium - Long-running operations (scrape/scoring) block UI
- **Mitigation**:
  - Operations run asynchronously (Convex actions)
  - Show progress indicators
  - Use polling or WebSockets for real-time updates (V2)
  - Allow canceling operations (V2)

---

## Dependencies

- Existing Convex schema (no new tables needed)
- Existing scraping logic (`scripts/scrape.mjs`)
- Existing scoring logic (`spots.scoreForecastSlots`)
- Environment variable: `ADMIN_PASSWORD`
- Next.js middleware support (for route protection)

---

## Open Questions

1. **Authentication Method**: Simple password or full user system?
   - **Decision**: Simple password for V1, full user system in V2

2. **Session Storage**: Cookies or database?
   - **Decision**: HTTP-only cookies for V1 simplicity

3. **Soft Deletes**: Should we soft-delete spots?
   - **Decision**: Hard deletes for V1, consider soft deletes in V2

4. **Real-Time Updates**: Should operations show real-time progress?
   - **Decision**: Polling for V1, WebSockets in V2

5. **Audit Logging**: Should we log all admin actions?
   - **Decision**: Not in V1, add in V2 if needed

6. **Multi-Admin Support**: When to add multiple admin accounts?
   - **Decision**: V2 feature, single admin for V1

---

## References

- PRD 01: Additional Features (spot management context)
- PRD 02: LLM-Based Condition Scoring System (prompt management context)
- PRD 03: User Authentication & Personalization (authentication patterns)
- Architecture Document: `/planning/architecture.md`
- Convex Schema: `convex/schema.ts`
- Existing Spot Functions: `convex/spots.ts`

---

**Document Maintained By**: Engineering Team  
**Last Updated**: 2025-12-28
